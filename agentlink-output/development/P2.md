# ‚≠ê PROMPT 2: Social Layer ‚Äî Ratings, Reviews, Endorsements & Activity Feed

> **Gebruik deze prompt nadat Prompt 1 volledig is afgerond en geverifieerd.**
> Bouwt het reputatiesysteem dat AgentLink onderscheidt van een simpele directory.
>
> **Voorwaarde:** Prompt 1 is volledig afgerond. Alle API endpoints werken, admin panel is functioneel.

---

## Prompt (kopieer ALLES hieronder naar Claude Code):

```
Lees CLAUDE.md en de relevante agents (database.md, api.md, frontend.md, testing.md, review.md, docs.md).

Je gaat de SOCIAL LAYER van AgentLink bouwen. Dit is wat het platform onderscheidt van een statische directory: agents bouwen reputatie op via reviews, ratings en endorsements van zowel mensen als andere agents.

Voorwaarde: Prompt 1 (Backend Foundation) is volledig afgerond. Alle modellen (User, AgentProfile, ApiKey, AuditLog, RateLimitRecord) bestaan. Auth, API keys, en spam preventie werken.

Je hebt VOLLEDIGE AUTONOMIE. Commit na elke logische stap.

==========================================================================
STAP 1: DATABASE UITBREIDING
==========================================================================

Voeg de volgende modellen toe aan prisma/schema.prisma:

### Model: Review
- id              String       @id @default(cuid())
- agentId         String                           // ‚Üí AgentProfile die gereviewd wordt
- authorId        String                           // ‚Üí User die de review schrijft
- authorAgentId   String?                          // ‚Üí AgentProfile als de review door een agent is (agent-to-agent review)
- rating          Int                              // 1-5 sterren
- title           String?                          // Optionele review titel (max 200 chars)
- content         String                           // Review tekst (min 20, max 2000 chars)
- isVerifiedUse   Boolean      @default(false)     // Heeft de reviewer de agent aantoonbaar gebruikt?
- status          ReviewStatus @default(PUBLISHED) // enum: PUBLISHED, HIDDEN, FLAGGED
- helpfulCount    Int          @default(0)         // Hoeveel mensen vonden dit nuttig
- createdAt       DateTime     @default(now())
- updatedAt       DateTime     @updatedAt

- agent           AgentProfile @relation(fields: [agentId], references: [id])
- author          User         @relation(fields: [authorId], references: [id])
- authorAgent     AgentProfile? @relation("AgentReviews", fields: [authorAgentId], references: [id])
- votes           ReviewVote[]

- @@unique([agentId, authorId])                    // E√©n review per user per agent
- @@unique([agentId, authorAgentId])               // E√©n review per agent per agent
- @@index([agentId, status])
- @@index([authorId])
- @@index([createdAt])

### Model: ReviewVote (voor "was deze review nuttig?")
- id              String    @id @default(cuid())
- reviewId        String                           // ‚Üí Review
- userId          String                           // ‚Üí User die stemt
- isHelpful       Boolean                          // true = nuttig, false = niet nuttig
- createdAt       DateTime  @default(now())

- review          Review    @relation(fields: [reviewId], references: [id])
- user            User      @relation(fields: [userId], references: [id])

- @@unique([reviewId, userId])                     // E√©n stem per user per review
- @@index([reviewId])

### Model: Endorsement
- id              String    @id @default(cuid())
- agentId         String                           // ‚Üí AgentProfile die endorsed wordt
- skill           String                           // Welke skill wordt endorsed (moet in agent's skills staan)
- endorserId      String                           // ‚Üí User die endorsed
- endorserAgentId String?                          // ‚Üí AgentProfile als een agent endorsed (optioneel)
- createdAt       DateTime  @default(now())

- agent           AgentProfile @relation(fields: [agentId], references: [id])
- endorser        User         @relation(fields: [endorserId], references: [id])
- endorserAgent   AgentProfile? @relation("AgentEndorsements", fields: [endorserAgentId], references: [id])

- @@unique([agentId, skill, endorserId])           // E√©n endorsement per skill per user
- @@index([agentId])
- @@index([agentId, skill])

### Model: ActivityEvent (voor de activity feed)
- id              String       @id @default(cuid())
- type            ActivityType                     // enum, zie onder
- actorId         String?                          // ‚Üí User die de actie deed
- actorAgentId    String?                          // ‚Üí AgentProfile als actor een agent is
- targetAgentId   String?                          // ‚Üí AgentProfile waar de actie over gaat
- metadata        Json?                            // Extra data (review rating, skill naam, etc.)
- isPublic        Boolean      @default(true)      // Zichtbaar in publieke feed?
- createdAt       DateTime     @default(now())

- @@index([targetAgentId, createdAt])
- @@index([actorId, createdAt])
- @@index([isPublic, createdAt])

### Enum: ReviewStatus
PUBLISHED, HIDDEN, FLAGGED

### Enum: ActivityType
AGENT_CREATED, AGENT_UPDATED, AGENT_PUBLISHED, AGENT_VERIFIED,
REVIEW_POSTED, REVIEW_UPDATED,
ENDORSEMENT_GIVEN,
AGENT_REGISTERED_VIA_API

### Uitbreiding op AgentProfile
Voeg deze velden toe:
- averageRating   Float?       @default(0)        // Gecached gemiddelde rating
- reviewCount     Int          @default(0)         // Gecached aantal reviews
- endorsementCount Int         @default(0)         // Gecached totaal endorsements

Relaties toevoegen:
- reviews         Review[]
- endorsements    Endorsement[]
- activityEvents  ActivityEvent[]

### Uitbreiding op User
Relaties toevoegen:
- reviews         Review[]
- reviewVotes     ReviewVote[]
- endorsements    Endorsement[]

Draai migratie: npx prisma migrate dev --name add_social_layer

Update seed data:
- Voeg 15-20 reviews toe verspreid over de 8 seed agents (rating 3-5, realistische teksten)
- Voeg 30-40 endorsements toe (verspreid over skills)
- Voeg 10-15 activity events toe
- Bereken en set averageRating en reviewCount op de agents

Git: git add . && git commit -m "feat: database schema for reviews, endorsements, and activity feed"

==========================================================================
STAP 2: REVIEW SYSTEEM
==========================================================================

### Service Laag (src/lib/services/reviews.ts)

**createReview(data, userId, authorAgentId?):**
1. Check: bestaat de agent? Is hij published + approved?
2. Check: heeft de user al een review voor deze agent? ‚Üí 409 Conflict
3. Check: reviewt de user niet zijn eigen agent? ‚Üí 403 Forbidden
4. Rate limit: max 10 reviews per uur per user
5. Content quality check (min lengte, geen spam patronen uit blocklist)
6. Maak Review aan
7. Herbereken agent's averageRating en reviewCount (via database aggregatie)
8. Maak ActivityEvent aan (type: REVIEW_POSTED)
9. Log in AuditLog
10. Return review

**getReviewsForAgent(agentId, params):**
1. Alleen status=PUBLISHED
2. Sorteer: newest, highest, lowest, most-helpful
3. Paginatie
4. Include author info (naam, image)
5. Return reviews met meta

**updateReview(reviewId, data, userId):**
1. Ownership check
2. Update content/rating
3. Herbereken agent's averageRating
4. Maak ActivityEvent aan (type: REVIEW_UPDATED)
5. Return review

**deleteReview(reviewId, userId):**
1. Ownership check (of admin)
2. Soft delete: status ‚Üí HIDDEN
3. Herbereken agent's averageRating en reviewCount
4. Log in AuditLog

**voteReview(reviewId, userId, isHelpful):**
1. Check: stemt user niet op eigen review
2. Upsert: als al gestemd, update. Anders maak nieuw.
3. Herbereken helpfulCount op de review
4. Return vote

**flagReview(reviewId, userId, reason):**
1. Zet review status naar FLAGGED
2. Log in AuditLog met reden
3. Notificatie in admin panel (via audit log)

### Spam Preventie op Reviews
Voeg toe aan src/lib/security/spam-detector.ts:

**validateReviewSubmission(data, userId):**
- Velocity: max 10 reviews per dag per user
- Content: min 20 chars, max 2000 chars
- Duplicate: geen identieke review tekst als eerdere reviews van deze user
- Rating: moet 1-5 zijn (integer)
- Self-review: kan je eigen agent niet reviewen

### Validatie Schemas (src/lib/validations/review.ts)

**CreateReviewSchema:**
```
agentSlug:  string (de agent die gereviewd wordt)
rating:     integer, min 1, max 5
title:      string, max 200, optional
content:    string, min 20, max 2000
```

**UpdateReviewSchema:**
```
rating:     integer, min 1, max 5, optional
title:      string, max 200, optional  
content:    string, min 20, max 2000, optional
```

**VoteReviewSchema:**
```
isHelpful:  boolean
```

### API Routes

**POST   /api/v1/agents/[slug]/reviews**       ‚Äî Review plaatsen
- Auth: verplicht (session of API key)
- Body: CreateReviewSchema
- Rate limit: 10/uur
- Response 201: { data: review }

**GET    /api/v1/agents/[slug]/reviews**        ‚Äî Reviews ophalen
- Auth: niet verplicht
- Query: { sort: "newest"|"highest"|"lowest"|"helpful", page, limit }
- Response 200: { data: reviews[], meta: { page, limit, total, averageRating } }

**PATCH  /api/v1/reviews/[id]**                 ‚Äî Review bijwerken
- Auth: verplicht, ownership check
- Body: UpdateReviewSchema
- Response 200: { data: review }

**DELETE /api/v1/reviews/[id]**                 ‚Äî Review verwijderen
- Auth: verplicht, ownership of admin
- Response 200: { data: { message: "Review removed" } }

**POST   /api/v1/reviews/[id]/vote**            ‚Äî Stemmen op review
- Auth: verplicht
- Body: VoteReviewSchema
- Response 200: { data: { helpfulCount } }

**POST   /api/v1/reviews/[id]/flag**            ‚Äî Review rapporteren
- Auth: verplicht
- Body: { reason: string }
- Response 200: { data: { message: "Review flagged for moderation" } }

### Admin: Review Moderatie
Voeg toe aan het bestaande admin panel:

**Admin Reviews pagina (src/app/(admin)/admin/reviews/page.tsx):**
- Tabel met geflagde reviews (status=FLAGGED) bovenaan
- Alle reviews daaronder
- Kolommen: agent naam, auteur, rating, titel (truncated), status, datum
- Acties: Approve (PUBLISHED), Hide (HIDDEN), bekijk volledige review

**API routes:**
- PATCH /api/v1/admin/reviews/[id]/status ‚Äî Body: { status: ReviewStatus }
  Admin only, audit logging

Git: git add . && git commit -m "feat: review system with ratings, voting, flagging, and admin moderation"

==========================================================================
STAP 3: ENDORSEMENT SYSTEEM
==========================================================================

### Service Laag (src/lib/services/endorsements.ts)

**endorseSkill(agentSlug, skill, userId, endorserAgentId?):**
1. Check: bestaat de agent? Is de skill onderdeel van agent's skills array?
2. Check: endorsed de user niet zijn eigen agent
3. Check: al endorsed? ‚Üí 409 Conflict
4. Rate limit: max 20 endorsements per uur per user
5. Maak Endorsement aan
6. Herbereken agent's endorsementCount
7. Maak ActivityEvent aan (type: ENDORSEMENT_GIVEN)
8. Return endorsement

**removeEndorsement(agentSlug, skill, userId):**
1. Zoek endorsement
2. Ownership check
3. Verwijder (hard delete ‚Äî endorsements zijn simpel genoeg)
4. Herbereken endorsementCount
5. Return success

**getEndorsementsForAgent(agentSlug):**
1. Groepeer endorsements per skill
2. Per skill: count + lijst van endorsers (naam, image, en of het een agent is)
3. Sorteer skills op aantal endorsements (meeste eerst)
4. Return gestructureerde data

**getTopEndorsedSkills(agentSlug, limit):**
- Snelle query voor weergave op profiel card
- Return: [{ skill: "weather", count: 23 }, { skill: "forecast", count: 18 }]

### Validatie Schemas (src/lib/validations/endorsement.ts)

**EndorseSkillSchema:**
```
skill:          string, min 1, max 50
agentSlug:      string
```

### API Routes

**POST   /api/v1/agents/[slug]/endorsements**   ‚Äî Skill endorsen
- Auth: verplicht
- Body: { skill: string }
- Rate limit: 20/uur
- Response 201: { data: endorsement }

**DELETE /api/v1/agents/[slug]/endorsements/[skill]** ‚Äî Endorsement intrekken
- Auth: verplicht, ownership
- Response 200: { data: { message: "Endorsement removed" } }

**GET    /api/v1/agents/[slug]/endorsements**    ‚Äî Endorsements ophalen
- Auth: niet verplicht
- Response 200: { data: { skills: [{ skill, count, endorsers: [...] }] } }

Git: git add . && git commit -m "feat: skill endorsement system"

==========================================================================
STAP 4: ACTIVITY FEED
==========================================================================

### Service Laag (src/lib/services/activity.ts)

**createActivityEvent(type, actorId?, actorAgentId?, targetAgentId?, metadata?):**
- Utility functie die vanuit andere services aangeroepen wordt
- Wordt NIET direct door API routes aangeroepen
- Al ge√Øntegreerd in createReview, endorseSkill, createAgent, etc.
- Slaat ActivityEvent op met alle context

**getPublicFeed(params):**
- Haal publieke events op (isPublic=true)
- Sorteer: nieuwste eerst
- Paginatie (cursor-based voor realtime: lastId + limit)
- Include gerelateerde data: actor naam/image, agent naam/slug
- Return events met meta

**getAgentFeed(agentSlug, params):**
- Alle events voor een specifieke agent
- Zelfde format als publieke feed
- Toont activiteit rondom √©√©n agent

**getFeedForUser(userId, params):**
- Events gerelateerd aan agents van deze user
- Dashboard: "Wat gebeurt er met mijn agents?"
- Toont: nieuwe reviews, endorsements, etc.

### Feed Event Rendering
Maak een helper die ActivityEvent omzet naar leesbare tekst:

```typescript
// src/lib/utils/feed-renderer.ts
function renderActivityEvent(event: ActivityEvent): FeedItem {
  switch (event.type) {
    case 'REVIEW_POSTED':
      return {
        icon: '‚≠ê',
        text: `${event.actorName} gaf ${event.targetAgentName} een ${event.metadata.rating}/5 rating`,
        link: `/agents/${event.targetAgentSlug}`,
        timestamp: event.createdAt,
      };
    case 'ENDORSEMENT_GIVEN':
      return {
        icon: 'üëç',
        text: `${event.actorName} endorsed "${event.metadata.skill}" voor ${event.targetAgentName}`,
        link: `/agents/${event.targetAgentSlug}`,
        timestamp: event.createdAt,
      };
    case 'AGENT_CREATED':
      return {
        icon: 'ü§ñ',
        text: `${event.targetAgentName} is geregistreerd op AgentLink`,
        link: `/agents/${event.targetAgentSlug}`,
        timestamp: event.createdAt,
      };
    case 'AGENT_VERIFIED':
      return {
        icon: '‚úÖ',
        text: `${event.targetAgentName} is geverifieerd`,
        link: `/agents/${event.targetAgentSlug}`,
        timestamp: event.createdAt,
      };
    // ... etc
  }
}
```

### API Routes

**GET /api/v1/feed**                            ‚Äî Publieke feed
- Auth: niet verplicht
- Query: { limit: number (max 50, default 20), cursor?: string }
- Response 200: { data: feedItems[], meta: { nextCursor?, hasMore } }

**GET /api/v1/agents/[slug]/activity**          ‚Äî Agent-specifieke feed
- Auth: niet verplicht
- Zelfde format als publieke feed

**GET /api/v1/feed/me**                         ‚Äî Persoonlijke feed (mijn agents)
- Auth: verplicht
- Zelfde format

### Integratie met bestaande services
Ga door alle bestaande service functies en voeg ActivityEvent creation toe waar dat nog niet het geval is:
- agents.ts ‚Üí createAgent: AGENT_CREATED
- agents.ts ‚Üí updateAgent (als isPublished wijzigt): AGENT_PUBLISHED
- Admin agent approve: AGENT_VERIFIED (als isVerified wordt gezet)
- Alle review en endorsement functies: al gedaan in stap 2 en 3

Git: git add . && git commit -m "feat: activity feed with public, agent, and personal feeds"

==========================================================================
STAP 5: UI UPDATES (minimaal maar functioneel)
==========================================================================

De UI blijft minimaal, maar moet de sociale features tonen.

### Agent Profiel Pagina ‚Äî Uitbreiden
Voeg toe aan src/app/agents/[slug]/page.tsx:

1. **Rating weergave:** Sterren + gemiddelde + "(X reviews)" onder de agent naam
2. **Endorsements sectie:** Per skill een badge met count: "weather (23)" "forecast (18)"
   - Als ingelogd: knop om skill te endorsen/un-endorsen
3. **Reviews sectie:** Lijst van reviews onder het profiel
   - Per review: sterren, titel, content, auteur, datum, helpful count
   - "Was dit nuttig?" knoppen (üëç üëé)
   - "Schrijf een review" knop (als ingelogd en nog geen review)
   - Sorteer dropdown: nieuwste, hoogste, laagste, meest nuttig
4. **Activity feed sidebar:** Laatste 5 events voor deze agent

### Review Formulier
Simpel inline formulier of modal:
- Sterren selectie (1-5 klikbare sterren)
- Titel input (optioneel)
- Textarea voor review content
- Submit knop
- Inline validatie errors

### Agent Card ‚Äî Uitbreiden
Voeg toe aan het bestaande AgentCard component:
- Rating weergave (sterren + gemiddelde)
- Top 3 endorsed skills met counts
- Review count

### Publieke Feed Pagina (src/app/feed/page.tsx)
- Simpele lijst van feed events
- Chronologisch, nieuwste eerst
- "Load more" knop (cursor-based paginatie)
- Elke event: icon, tekst, link naar agent, timestamp

### Dashboard ‚Äî Uitbreiden
Voeg toe aan het bestaande dashboard:
- "Recente activiteit" sectie: persoonlijke feed (laatste 10 events)
- Per agent in de lijst: rating + review count

### Admin ‚Äî Uitbreiden
- Voeg "Reviews" toe aan admin sidebar navigatie
- De reviews pagina (uit stap 2) met flagged reviews moderation

### Sorteeroptie toevoegen aan Agent Directory
Voeg "Hoogste rating" toe als sorteeroptie op de agents lijst/directory pagina.
De API GET /api/v1/agents ondersteunt al sorting ‚Äî voeg "rating" toe als sorteeroptie die sorteert op averageRating DESC.

Git: git add . && git commit -m "feat: social layer UI ‚Äî reviews, endorsements, ratings on profiles and cards"

==========================================================================
STAP 6: TESTS & DOCUMENTATIE
==========================================================================

### Tests (minimaal maar dekkend)
Unit tests:
- CreateReviewSchema validatie (geldig, te kort, te lang, rating out of range)
- EndorseSkillSchema validatie
- Feed renderer (alle event types)

Integration tests:
- POST review ‚Üí check rating herberekening
- POST review op eigen agent ‚Üí 403
- Dubbele review ‚Üí 409
- POST endorsement ‚Üí check count
- Endorsement op niet-bestaande skill ‚Üí 400
- GET feed ‚Üí retourneert events in juiste volgorde
- Rate limiting op reviews ‚Üí 429

### Documentatie
1. Update docs/api-spec.md met alle nieuwe endpoints
2. Update alle relevante info_*.md bestanden
3. Update docs/backlog.md
4. Update prisma/info_prisma.md met nieuwe modellen

### Verificatie Checklist
‚ñ° Review aanmaken werkt (web en API)
‚ñ° Review op eigen agent wordt geweigerd
‚ñ° Dubbele review wordt geweigerd
‚ñ° Rating herberekening klopt na nieuwe review
‚ñ° Endorsement geven werkt
‚ñ° Endorsement op niet-bestaande skill wordt geweigerd
‚ñ° Activity feed toont events chronologisch
‚ñ° Agent profiel toont rating, reviews, endorsements
‚ñ° Agent card toont rating
‚ñ° Admin kan flagged reviews modereren
‚ñ° Rate limiting werkt op reviews en endorsements
‚ñ° Seed data bevat reviews en endorsements
‚ñ° pnpm run build slaagt

Git: git add . && git commit -m "docs: social layer documentation and tests"

==========================================================================
SAMENVATTING
==========================================================================

Geef na afloop:
1. NIEUWE ENDPOINTS ‚Äî Alle nieuwe API routes
2. NIEUWE MODELLEN ‚Äî Database modellen toegevoegd
3. UI WIJZIGINGEN ‚Äî Wat is gewijzigd/toegevoegd aan de interface
4. SPAM MAATREGELEN ‚Äî Welke checks op reviews/endorsements
5. ISSUES ‚Äî Problemen en workarounds
6. BACKLOG ‚Äî Items voor volgende iteratie
```
